# BonaRes-LTE to ICASA data map (v1.2.0; restructured with explicit lookups, prefixes removed)

# =================================================================
# DEFINITIONS & ANCHORS
# =================================================================

definitions:

  crop_name_map_icc: &crop_name_map_icc
    '1.01': 'WHT'
    '1.02': 'MAZ'
    '1.05': 'BAR'
    '5.01': 'POT'
    '8.01': 'SBT'

  # crop_name_map_sci: &crop_name_map_sci
  #   '1.01': 'WHT'
  #   '1.02': 'MAZ'
  #   '1.05': 'BAR'
  #   '5.01': 'POT'
  #   '8.01': 'SBT'

  crop_name_map_en: &crop_name_map_en
    'winter wheat': 'WHT'
    'spring wheat': 'WHT'
    'maize': 'MAZ'
    'winter barley': 'BAR'
    'spring barley': 'BAR'
    'potato': 'POT'
    'sugar beet': 'SBT'

  crop_name_map_de: &crop_name_map_de
    'Winterweizen': 'WHT'
    'Sommerweizen': 'WHT'
    'Körnermais': 'MAZ'
    'Wintergerste': 'BAR'
    'Sommergerste': 'BAR'
    'Kartoffel': 'POT'
    'Zuckerrübe': 'SBT'

  fertilizer_material_map: &fertilizer_material_map
    'Harnstoff': 'FE005'
    'Triplesuperphosphat': 'FE014'
    'Ammon-Sulfat-Salpeter': 'FE060'
    'Kalkammonsalpeter': 'FE011'
    'Kalkstickstoff': 'FE050'
    'Ammonium-Nitrat-Harnstoff-Lösung': 'FE010'
  fertilizer_material_default: &fertilizer_material_default FE900

  # Note 2025-09-18: placeholding map; to design
  chemical_material_map: &chemical_material_map
    'Inzektizid1': 'FE001'
    'Inzektizid2': 'FE002'
  chemical_material_default: &chemical_material_default NA

  harvest_method_map: &harvest_method_map
    'Mähdrusch':	'HM001'
    'Erntemethode unbekannt': 'HM999'
  harvest_method_default: &harvest_method_default HM999


# =================================================================
# MAPPING RULES
# =================================================================

rules:

# -----------------------------------------------------------------
# PHASE 1: Data Transformation and Lookups
# -----------------------------------------------------------------

## --- SECTION: GENERAL, PERSONS, INSTITUTIONS, DOCUMENTS ---

  - mapping_uid: '1'
    notes: "Selects and renames columns from METADATA for the GENERAL section."
    source:
      section: METADATA
    target:
      section: GENERAL
    select_final_columns:
      name_of_experiment: Experiment_title
      experiment_narrative:
        header: Abstract
        synonyms: [Summary]
      ex_funding_source: Funding
      distrib_restrictions: Legal_constrainsts
      revision_date_first: Date_published
      revision_date_latest: Date_revised

  - mapping_uid: '2'
    notes: "Generates PERSONS table from contact information in the METADATA table."
    source:
      section: PERSONS
    target:
      section: PERSONS
    actions:
      - type: split_and_map_text   # TODO: rename (split_column) and generalize
        input_map:
          x: Contact_persons
        output_map:
          - {output_header: researcher_first_name, component: first}
          - {output_header: researcher_last_name, component: last}
          - {output_header: researcher_name_mi, component: middle}
        delimiter: " "
    select_final_columns:
      e_mail_address: Contact_email
      researcher_first_name: researcher_first_name
      researcher_last_name: researcher_last_name
      researcher_name_mi: researcher_name_mi

  - mapping_uid: '3'
    notes: "Selects and renames columns from METADATA for the INSTITUTIONS section."
    source:
      section: INSTITUTIONS
    target:
      section: INSTITUTIONS
    select_final_columns:
      institute_name: Institutions

  - mapping_uid: '4'
    notes: "Selects and renames columns from METADATA for the DOCUMENTS section."
    source:
      section: METADATA
    target:
      section: DOCUMENTS
    select_final_columns:
      digital_object_id: Experiment_doi


## --- SECTION: TREATMENTS ---

  - mapping_uid: '5' 
    notes: "Build TREATMENTS table from VERSUCHSAUFBAU and its linked tables."
    source:
      section: VERSUCHSAUFBAU
    target:
      section: TREATMENTS
    actions:
      # Look up and add data from the PARZELLE table.
      - type: lookup_and_add
        lookup_data_source: { section: PARZELLE }
        on_key:
          source_key: [Pruefglied_ID, Parzelle_ID]
          lookup_key: [Pruefglied_ID, Parzelle_ID]
        select_columns:
          replicate_number: Wiederholung
          plot_geocoord_x: Mittelpunkt_x_GK
          plot_geocoord_y: Mittelpunkt_y_GK
          plot_geocoord_system: { type: static, value: 'GK' }
      # Step 3: Perform the two-step join to get Factor IDs and then their descriptions into temporary columns.
      - type: lookup_and_add
        lookup_data_source: { section: PRUEFGLIED }
        on_key: { source_key: Pruefglied_ID, lookup_key: Pruefglied_ID }
        select_columns:
          Faktor1_Stufe_ID: Faktor1_Stufe_ID
          Faktor2_Stufe_ID: Faktor2_Stufe_ID
          Faktor3_Stufe_ID: Faktor3_Stufe_ID
      - type: lookup_and_add
        lookup_data_source: { section: FAKTOR1_STUFE }
        on_key: { source_key: Faktor1_Stufe_ID, lookup_key: Faktor1_Stufe_ID }
        select_columns:
          temp_name1: Name
          temp_desc1: Beschreibung
      - type: lookup_and_add
        lookup_data_source: { section: FAKTOR2_STUFE }
        on_key: { source_key: Faktor2_Stufe_ID, lookup_key: Faktor2_Stufe_ID }
        select_columns:
          temp_name2: Name
          temp_desc2: Beschreibung
      - type: lookup_and_add
        lookup_data_source: { section: FAKTOR3_STUFE }
        on_key: { source_key: Faktor3_Stufe_ID, lookup_key: Faktor3_Stufe_ID }
        select_columns:
          temp_name3: Name
          temp_desc3: Beschreibung
      # Concatenate the temporary factor columns into the final treatment name and comments.
      - type: concatenate_columns
        output_header: treatment_name
        input_map:
          f1: temp_name1
          f2: temp_name2
          f3: temp_name3
        separator: " + "
        on_missing: proceed
      - type: concatenate_columns
        output_header: treatment_comments
        input_map:
          d1: temp_desc1
          d2: temp_desc2
          d3: temp_desc3
        separator: "; "
        on_missing: proceed
      # Look up all management and resource level IDs.
      - type: lookup_and_add
        lookup_data_source: { section: AUSSAAT }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          planting_level: Aussaat_ID
      - type: lookup_and_add
        lookup_data_source: { section: SORTE }
        on_key: { source_key: Kultur_ID, lookup_key: Kultur_ID }
        select_columns:
          genotype_level: Sorte_ID
      ## Split DUENGUNG IDs into fertilizers and organic_materials
      - type: lookup_and_add
        lookup_data_source: { section: DUENGUNG }
        filter: 
          on_presence_of_columns:
            - { header: Masse_mineralisch, synonyms: [Menge_Duengemittel] }
            - { header: Stickstoff,        synonyms: [Stickstoff_min, 'N'] }
            - { header: Phosphor,          synonyms: [P] }
            - { header: Kalium,            synonyms: [K] }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          fertilizer_level: Duengung_ID
      - type: lookup_and_add
        lookup_data_source: { section: DUENGUNG }
        filter:
          on_presence_of_columns: [Frischmasse, Trockenmasse, Trockensubstanz]
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          org_materials_applic_lev: Duengung_ID
      - type: lookup_and_add
        lookup_data_source: { section: BEREGNUNG }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          irrigation_level: Beregnung_ID
      - type: lookup_and_add
        lookup_data_source: { section: PFLANZENSCHUTZ }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          chemical_applic_level: Pflanzenschutz_ID
      - type: lookup_and_add
        lookup_data_source: { section: BODENBEARBEITUNG }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          tillage_level: Bodenbearbeitung_ID
      - type: lookup_and_add
        lookup_data_source: { section: ERNTE }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          harvest_operations_level: Ernte_ID
      # Look up the crop_id using the prioritized coalesce map.
      - type: lookup_and_add
        lookup_data_source: { section: KULTUR }
        on_key: { source_key: Kultur_ID, lookup_key: Kultur_ID }
        select_columns:
          crop_id:
            type: coalesce_map
            maps:
              - { from: Kultur, map: *crop_name_map_de }
              - { from: Icc_Code, map: *crop_name_map_icc }
    select_final_columns:
      experiment_year: Versuchsjahr
      treatment_number: Pruefglied_ID
      treatment_name: treatment_name
      plot_id: Parzelle_ID
      plot_geocoord_x: plot_geocoord_x
      plot_geocoord_y: plot_geocoord_y
      plot_geocoord_system: plot_geocoord_system
      replicate_number: replicate_number
      crop_id: crop_id
      genotype_level: genotype_level
      planting_level: planting_level
      irrigation_level: irrigation_level
      fertilization_level: fertilization_level
      org_materials_applic_lev: org_materials_applic_lev
      chemical_applic_level: chemical_applic_level
      tillage_level: tillage_level
      harvest_operations_level: harvest_operations_level
      treatment_comments: treatment_comments


## --- SECTION: FIELDS ---

  - mapping_uid: '6'
    notes: "Builds a plot-level FIELDS table from the PARZELLE table for later aggregation."
    source:
      section: VERSUCHSAUFBAU
    target:
      section: FIELDS
    actions:
      # Joins the necessary spatial data from the PARZELLE table.
      - type: lookup_and_add
        lookup_data_source: { section: PARZELLE }
        on_key: { source_key: Parzelle_ID, lookup_key: Parzelle_ID }
        select_columns:
          # Use intermediate names as inputs for downstream aggregation logic
          plot_latitude: Mittelpunkt_y_GK
          plot_longitude: Mittelpunkt_x_GK
          plot_elevation_min: Hoehenlage_Min
          plot_elevation_max: Hoehenlage_Max
          coordinate_system: { type: static, value: 'GK' }
      # Generate field elevation    
      - type: rowwise_transform
        output_header: plot_elevation
        input_map:
          elev_min: plot_elevation_min
          elev_max: plot_elevation_max
        formula: "(elev_min + elev_max) / 2"
    select_final_columns:
      experiment_year: Versuchsjahr
      treatment_number: Pruefglied_ID   # REVIEW: check if needed
      plot_id: Parzelle_ID
      plot_latitude: plot_latitude
      plot_longitude: plot_longitude
      plot_elevation: plot_elevation
      coordinate_system: coordinate_system   # TODO: transform action to use other coordinate system based on header type
       
          
## --- SECTION: GENOTYPES ---

  - mapping_uid: '7'
    notes: "Builds the GENOTYPES table by chaining joins through SAAT_PFLANZGUT and SORTE."
    source:
      section: AUSSAAT
    target:
      section: GENOTYPES
    actions:
      # Look up the treatment level to process management regime IDs
      - type: lookup_and_add
        lookup_data_source: { section: VERSUCHSAUFBAU }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          treatment_number: Pruefglied_ID
      # Append crop name through chain join and map crop codes
      - type: lookup_and_add
        lookup_data_source: { section: SAAT_PFLANZGUT }
        on_key: { source_key: Saat_Pflanzgut_ID, lookup_key: Saat_Pflanzgut_ID }
        select_columns:
          Sorte_ID: Sorte_ID
      - type: lookup_and_add
        lookup_data_source: { section: SORTE }
        on_key: { source_key: Sorte_ID, lookup_key: Sorte_ID }
        select_columns:
          genotype_level: Sorte_ID
          genotype_name: Sorte
          Kultur_ID: Kultur_ID
      - type: lookup_and_add
        lookup_data_source: { section: KULTUR }
        on_key: { source_key: Kultur_ID, lookup_key: Kultur_ID }
        select_columns:
          crop_id:
            type: coalesce_map
            maps:
              - { from: Icc_Code, map: *crop_name_map_icc }
              - { from: Kultur, map: *crop_name_map_de }
    select_final_columns:
      experiment_year: Versuchsjahr
      treatment_number: treatment_number
      genotype_level: genotype_level
      genotype_name: genotype_name
      crop_id: crop_id
 

## --- SECTION: INITIAL_CONDITIONS ---

  - mapping_uid: '8'
    notes: "Builds the INITIAL_CONDITIONS table by retrieving the previous crop from the FRUCHTFOLGE table"
    source:
      section: FRUCHTFOLGE
    target:
      section: INITIAL_CONDITIONS
    actions:
      # Look up the treatment level to process management regime IDs
      - type: lookup_and_add
        lookup_data_source: { section: VERSUCHSAUFBAU }
        on_key:
          source_key: [Versuchsjahr, Kultur_ID]
          lookup_key: [Versuchsjahr, Kultur_ID]
        select_columns:
          treatment_number: Pruefglied_ID
      # STEP 1: Rename original columns to prevent self-join name collision
      - type: rename_column
        input_name: Kultur_ID
        output_name: temp_current_crop
      - type: rename_column
        input_name: Vorfrucht
        output_name: temp_current_flag
      # STEP 2: Get the main crop from the PREVIOUS year
      - type: rowwise_transform
        output_header: temp_prev_year
        input_map: { x: Versuchsjahr }
        formula: "x - 1"
      - type: lookup_and_add
        lookup_data_source: { section: FRUCHTFOLGE }
        on_key:
          source_key: [temp_prev_year]
          lookup_key: [Versuchsjahr]
        filter_lookup:
          column: Vorfrucht
          equals: 0
        select_columns:
          temp_last_year_crop: Kultur_ID
      # STEP 3: Get the cover crop from the SAME year
      - type: lookup_and_add
        lookup_data_source: { section: FRUCHTFOLGE }
        on_key:
          source_key: [Versuchsjahr]
          lookup_key: [Versuchsjahr]
        filter_lookup:
          column: Vorfrucht
          equals: 1
        select_columns:
          temp_same_year_cover_crop: Kultur_ID
      # STEP 4: Create the final 'same year' previous crop value, ONLY for main crops
      - type: rowwise_transform
        output_header: temp_final_same_year_crop
        input_map:
          flag: temp_current_flag  #<-- Use the renamed flag column
          crop: temp_same_year_cover_crop
        formula: "ifelse(flag == 0, crop, NA)"
      # STEP 5: Coalesce results to get the definitive previous_crop ID
      - type: coalesce_columns
        output_header: previous_crop_id
        input_map:
          x: temp_final_same_year_crop
          y: temp_last_year_crop
      # STEP 6: Look up the name of the previous crop
      - type: lookup_and_add
        lookup_data_source: { section: KULTUR }
        on_key: { source_key: previous_crop_id, lookup_key: Kultur_ID }
        select_columns:
          residue_nature_prev_crop:
            type: coalesce_map
            maps:
              - { from: Icc_Code, map: *crop_name_map_icc }
              - { from: Kultur, map: *crop_name_map_de }
    select_final_columns:
      experiment_year: Versuchsjahr
      treatment_number: treatment_number
      initial_conditions_level: Fruchtfolge_ID
      residue_nature_prev_crop: residue_nature_prev_crop


## --- SECTION: PLANTINGS ---

  - mapping_uid: '8'
    notes: "Assembles the PLANTINGS table from AUSSAAT and its linked tables."
    source:
      section: AUSSAAT
    target:
      section: PLANTINGS
    actions:
      # Look up the treatment level to process management regime IDs
      - type: lookup_and_add
        lookup_data_source: { section: VERSUCHSAUFBAU }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          treatment_number: Pruefglied_ID
      # Look up and organize comments from the event and the planting stock
      - type: lookup_and_add
        lookup_data_source: { section: SAAT_PFLANZGUT }
        on_key: { source_key: Saat_Pflanzgut_ID, lookup_key: Saat_Pflanzgut_ID }
        select_columns:
          Sorte_ID: Sorte_ID
          stock_comment_id: Bemerkungen_ID
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          event_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: stock_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          stock_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: planting_notes
        input_map:
          event_comment: event_comment_text
          stock_comment: stock_comment_text
        separator: "; "
        on_missing: proceed
      # Look up and recode crop name via chained join
      - type: lookup_and_add
        lookup_data_source: { section: SORTE }
        on_key: { source_key: Sorte_ID, lookup_key: Sorte_ID }
        select_columns:
          Kultur_ID: Kultur_ID
      - type: lookup_and_add
        lookup_data_source: { section: KULTUR }
        on_key: { source_key: Kultur_ID, lookup_key: Kultur_ID }
        select_columns:
          crop_id:
            type: coalesce_map
            maps:
              - { from: Icc_Code, map: *crop_name_map_icc }
              - { from: Kultur, map: *crop_name_map_de }
      # Look up and map machinery data
      - type: lookup_and_add
        lookup_data_source: { section: TECHNIK }
        on_key: { source_key: Technik_ID, lookup_key: Technik_ID }
        select_columns:
          technology: Technik
          type: Art
          description: Beschreibung
      - type: concatenate_columns
        output_header: planting_method
        input_map:
          x: technology
          y: type
          z: description
        separator: "; "
        on_missing: proceed
    select_final_columns:
      experiment_year: Versuchsjahr
      treatment_number: treatment_number
      planting_level: Aussaat_ID
      crop_id: crop_id
      planting_date: Termin
      plant_pop_at_planting: Saatstaerke_Anzahl_m2
      planting_material_weight: Saatstaerke_kg_ha
      row_spacing: Reihenabstand
      plant_spacing: Pflanzenabstand
      planting_method: planting_method
      planting_notes: planting_notes


## --- SECTION: IRRIGATIONS ---

  - mapping_uid: '9'
    notes: "Assembles the IRRIGATIONS table from BEREGNUNG with necessary lookups."
    source:
      section: BEREGNUNG
    target:
      section: IRRIGATIONS
    actions:
      # Look up the general irrigation flag from the main design table.  # TODO: drop??
      - type: lookup_and_add
        lookup_data_source: { section: VERSUCHSAUFBAU }
        on_key:
          source_key: [Versuchsjahr, Pruefglied_ID, Parzelle_ID, Kultur_ID]
          lookup_key: [Versuchsjahr, Pruefglied_ID, Parzelle_ID, Kultur_ID]
        select_columns:
          irrig_applied: Bewaesserung
      # Look up the comment text for the irrigation event.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          irrig_applic_comment: Bemerkungen
    select_final_columns:
      experiment_year: Versuchsjahr
      irrigation_level: Beregnung_ID
      irrig_applied: irrig_applied
      irrigation_date: Termin
      irrig_amount_depth: Menge
      irrig_applic_comment: irrig_applic_comment


## --- SECTIONS FERTILIZERS ---

  - mapping_uid: '10'
    notes: "Builds the FERTILIZERS table from the mineral fertilizer rows in DUENGUNG."
    source:
      section: DUENGUNG
    target:
      section: FERTILIZERS
    actions:
      # Filter the source table to keep only mineral fertilizer rows.
      - type: filter_rows
        on_presence_of_columns:
          - { header: Masse_mineralisch, synonyms: [Menge_Duengemittel] }
          - { header: Stickstoff,        synonyms: [Stickstoff_min, 'N'] }
          - { header: Phosphor,          synonyms: [P] }
          - { header: Kalium,            synonyms: [K] }
      # Look up the treatment level to process management regime IDs
      - type: lookup_and_add
        lookup_data_source: { section: VERSUCHSAUFBAU }
        on_key:
          source_key: [Versuchsjahr, Parzelle_ID]
          lookup_key: [Versuchsjahr, Parzelle_ID]
        select_columns:
          treatment_number: Pruefglied_ID
      # Look up the fertilizer material name and the material's comment ID.
      - type: lookup_and_add
        lookup_data_source: { section: DUENGEMITTEL }
        on_key: { source_key: Duengemittel_ID, lookup_key: Duengemittel_ID }
        select_columns:
          fertilizer_material:
            type: map_values
            input_map: { x: Name }
            map: *fertilizer_material_map
            default_value: *fertilizer_material_default
          temp_material_comment_id: Bemerkungen_ID
      # Look up both event and material comments, then concatenate them.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_event_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: temp_material_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_material_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: fertiliz_applic_comment
        input_map:
          event_comment: temp_event_comment_text
          material_comment: temp_material_comment_text
        separator: "; "
        on_missing: proceed
      # Look up and build the application method description.
      - type: lookup_and_add
        lookup_data_source: { section: TECHNIK }
        on_key: { source_key: Technik_ID, lookup_key: Technik_ID }
        select_columns:
          temp_technik: Technik
          temp_art: Art
          temp_beschreibung: Beschreibung
      - type: concatenate_columns
        output_header: fertilizer_applic_method
        input_map:
          tech: temp_technik
          art: temp_art
          desc: temp_beschreibung
        separator: "; "
        on_missing: proceed
      # Calculate all elemental nutrient rates using the "transform then coalesce" pattern.
      - type: rowwise_transform
        output_header: temp_P_from_oxide
        input_map:
          x: { header: Diphosphorpentoxid, synonyms: [Phosphorpentoxid, P2O5] }
        formula: "x * 0.436"
      - type: coalesce_columns
        output_header: phosphorus_applied_fert
        input_map:
          elemental: { header: Phosphor, synonyms: [P] }
          from_oxide: temp_P_from_oxide
      - type: rowwise_transform
        output_header: temp_K_from_oxide
        input_map:
          x: { header: Dikaliumoxid, synonyms: [Kaliumoxid, K2O] }
        formula: "x * 0.830"
      - type: coalesce_columns
        output_header: fertilizer_K_applied
        input_map:
          elemental: { header: Kalium, synonyms: [K] }
          from_oxide: temp_K_from_oxide
      - type: rowwise_transform
        output_header: temp_Mg_from_oxide
        input_map:
          x: { header: Magnesiumoxid, synonyms: [Magnesia, MgO] }
        formula: "x * 0.603"
      - type: coalesce_columns
        output_header: Mg_in_applied_fertilizer
        input_map:
          elemental: { header: Magnesium, synonyms: [Mg] }
          from_oxide: temp_Mg_from_oxide
      - type: rowwise_transform
        output_header: temp_Ca_from_oxide
        input_map:
          x: { header: Calciumoxid, synonyms: [Gebrannter_Kalk, Branntkalk, CaO] }
        formula: "x * 0.715"
      - type: coalesce_columns
        output_header: Ca_in_applied_fertilizer
        input_map:
          elemental: { header: Kalzium, synonyms: [Calcium, Ca] }
          from_oxide: temp_Ca_from_oxide
    # Define the final, clean output for the FERTILIZERS table.
    select_final_columns:
      # New ICASA Name: Original BonaRes Name (or name created by an action)
      experiment_year: Versuchsjahr
      treatment_number: treatment_number
      fertilizer_level: Duengung_ID
      fertilization_date: Termin
      fertilizer_material: fertilizer_material
      fertilizer_total_amount: { header: Masse_mineralisch, synonyms: [Menge_Duengemittel] }
      N_in_applied_fertilizer: { header: Stickstoff, synonyms: [Stickstoff_min, 'N'] }
      phosphorus_applied_fert: phosphorus_applied_fert
      fertilizer_K_applied: fertilizer_K_applied
      Mg_in_applied_fertilizer: Mg_in_applied_fertilizer
      Ca_in_applied_fertilizer: Ca_in_applied_fertilizer
      S_in_applied_fertilizer: { header: Schwefel, synonyms: [S] }
      B_in_applied_fertilizer: { header: Bor, synonyms: [B] }
      Zn_in_applied_fertilizer: { header: Zink, synonyms: [Zn] }
      Mn_in_applied_fertilizer: { header: Mangan, synonyms: [Mn] }
      Fe_in_applied_fertilizer: { header: Eisen, synonyms: [Fe] }
      fertilizer_applic_method: fertilizer_applic_method  
      fertiliz_applic_comment: fertiliz_applic_comment
        
      
## --- SECTIONS ORGANIC_MATERIALS ---

  - mapping_uid: '11'
    notes: "Builds the ORGANIC_MATERIALS table from the organic rows in DUENGUNG."
    source:
      section: DUENGUNG
    target:
      section: ORGANIC_MATERIALS
    actions:
      # Filter to keep only organic material rows.
      - type: filter_rows
        on_presence_of_columns:
          - Frischmasse
          - Trockenmasse
          - Trockensubstanz   
      # Look up material name and comments.
      - type: lookup_and_add
        lookup_data_source: { section: DUENGEMITTEL }
        on_key: { source_key: Duengemittel_ID, lookup_key: Duengemittel_ID }
        select_columns:
          organic_material:
            type: map_values
            input_map: { x: Name }
            map: *fertilizer_material_map # TODO: Change to an organic material map when needed
          temp_material_comment_id: Bemerkungen_ID
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_event_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: temp_material_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_material_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: org_matter_comment
        input_map:
          event_comment: temp_event_comment_text
          material_comment: temp_material_comment_text
        separator: "; "
        on_missing: proceed
      # Look up and build the application method description.
      - type: lookup_and_add
        lookup_data_source: { section: TECHNIK }
        on_key: { source_key: Technik_ID, lookup_key: Technik_ID }
        select_columns:
          temp_technik: Technik
          temp_art: Art
          temp_beschreibung: Beschreibung
      - type: concatenate_columns
        output_header: org_material_applic_meth
        input_map:
          tech: temp_technik
          art: temp_art
          desc: temp_beschreibung
        separator: "; "
        on_missing: proceed
      # Coalesce the nutrient concentration columns
      # Note 2025-09-09: fw/dw not distinguished in ICASA. Currently coalesce (assuming either, not both, are present in an individual dataset)
      # TODO: add function to calculate org_matter_moisture_conc from DUENGUNG.Trockensubstanz
      - type: coalesce_columns
        output_header: organic_material_N_conc
        input_map:
          in_tm: Stickstoff_In_Trockenmasse
          in_fm: Stickstoff_In_Frischmasse
      - type: coalesce_columns
        output_header: organic_material_P_conc
        input_map:
          in_tm: Phosphor_In_Trockenmasse
          in_fm: Phosphor_In_Frischmasse
      - type: coalesce_columns
        output_header: organic_material_K_conc
        input_map:
          in_tm: Kalium_In_Trockenmasse
          in_fm: Kalium_In_Frischmasse
      # Convert application weight units.
      - type: rowwise_transform
        output_header: org_material_applic_fresh_wt
        input_map: { x: Frischmasse }
        formula: "x * 1000"
      - type: rowwise_transform
        output_header: org_material_applic_amnt
        input_map: { x: Trockenmasse }
        formula: "x * 100"
    select_final_columns:
      experiment_year: Versuchsjahr
      org_materials_applic_lev: Duengung_ID
      org_material_applic_date: Termin
      organic_material: organic_material
      org_material_applic_fresh_wt: org_material_applic_fresh_wt
      org_material_applic_amnt: org_material_applic_amnt
      organic_material_N_conc: organic_material_N_conc
      organic_material_P_conc: organic_material_P_conc
      organic_material_K_conc: organic_material_K_conc
      org_material_applic_meth: org_material_applic_meth
      org_matter_comment: org_matter_comment
      

## --- SECTION: CHEMICALS ---

  - mapping_uid: '12'
    notes: "Assembles the CHEMICALS table with all necessary lookups."
    source:
      section: PFLANZENSCHUTZ
    target:
      section: CHEMICALS
    actions:
      # Look up material details and the material's comment ID.
      - type: lookup_and_add
        lookup_data_source: { section: PFLANZENSCHUTZMITTEL }
        on_key: { source_key: Pflanzenschutz_Mittel_ID, lookup_key: Pflanzenschutz_Mittel_ID }
        select_columns:
          temp_chemical_name: Name
          temp_active_substance_name: Wirkstoff
          temp_material_comment_id: Bemerkungen_ID
      # Look up and concatenate event and material comments.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_event_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: temp_material_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_material_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: chemical_applic_comment
        input_map:
          event_comment: temp_event_comment_text
          material_comment: temp_material_comment_text
        separator: "; "
        on_missing: proceed
      # Concatenate the material name and active substance.
      - type: concatenate_columns
        output_header: chemical_applic_material
        input_map:
          name: temp_chemical_name
          substance: temp_active_substance_name
        separator: " | "
        on_missing: proceed
      - type: map_values
        input_map: { x: chemical_applic_material }
        output_header: chemical_applic_material
        map: *chemical_material_map
        default_value: *chemical_material_default
      # Coalesce the two different amount columns into one.
      # Note 2025-09-10: temporary workaround (no unit distinction in ICASA)
      - type: coalesce_columns
        output_header: chemical_applic_amount
        input_map:
          dose_kg: Menge_kg_ha
          dose_l: Menge_l_ha
      # Look up and concatenate the application method.
      - type: lookup_and_add
        lookup_data_source: { section: TECHNIK }
        on_key: { source_key: Technik_ID, lookup_key: Technik_ID }
        select_columns:
          temp_technik: Technik
          temp_art: Art
          temp_beschreibung: Beschreibung
      - type: concatenate_columns
        output_header: chemical_applic_method
        input_map:
          tech: temp_technik
          art: temp_art
          desc: temp_beschreibung
        separator: "; "
        on_missing: proceed
    select_final_columns:
      experiment_year: Versuchsjahr
      chemical_applic_level: Pflanzenschutz_ID
      chemical_applic_date: Termin
      chemical_applic_material: chemical_applic_material
      chemical_applic_amount: chemical_applic_amount
      chemical_applic_method: chemical_applic_method
      chemical_applic_comment: chemical_applic_comment


## --- SECTION: TILLAGE ---

  - mapping_uid: '13'
    notes: "Assembles the TILLAGE table from BODENBEARBEITUNG and its linked tables."
    source:
      section: BODENBEARBEITUNG
    target:
      section: TILLAGE
    actions:  
      # Look up the operation name and its specific comment ID.
      - type: lookup_and_add
        lookup_data_source: { section: BODENBEARBEITUNG_MASSNAHME }
        on_key: { source_key: Bodenbearbeitung_Massnahme_ID, lookup_key: Bodenbearbeitung_Massnahme_ID }
        select_columns:
          tillage_operation_name: Massnahme
          temp_operation_comment_id: Bemerkungen_ID
      # Look up and concatenate event and operation comments.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_event_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: temp_operation_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_operation_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: till_op_comment
        input_map:
          event_comment: temp_event_comment_text
          op_comment: temp_operation_comment_text
        separator: "; "
        on_missing: proceed
      # Look up and concatenate the implement details.
      - type: lookup_and_add
        lookup_data_source: { section: TECHNIK }
        on_key: { source_key: Technik_ID, lookup_key: Technik_ID }
        select_columns:
          temp_technik: Technik
          temp_art: Art
          temp_beschreibung: Beschreibung
      - type: concatenate_columns
        output_header: tillage_implement
        input_map:
          tech: temp_technik
          art: temp_art
          desc: temp_beschreibung
        separator: "; "
        on_missing: proceed
    select_final_columns:
      experiment_year: Versuchsjahr
      tillage_level: Bodenbearbeitung_ID
      tillage_date: Termin
      tillage_operation_name: tillage_operation_name
      tillage_implement: tillage_implement
      tillage_operations_depth: Tiefe
      till_op_comment: till_op_comment


## --- SECTION: HARVESTS ---

  - mapping_uid: '14'
    notes: "Assembles the HARVESTS table with all necessary lookups and transformations."
    source:
      section: ERNTE
    target:
      section: HARVESTS
    actions:      
      # Look up and recode crop name via chained join
      - type: lookup_and_add
        lookup_data_source: { section: SAAT_PFLANZGUT }
        on_key: { source_key: Saat_Pflanzgut_ID, lookup_key: Saat_Pflanzgut_ID }
        select_columns:
          Sorte_ID: Sorte_ID
          Saat_Pflanzgut_ID: Saat_Pflanzgut_ID
      - type: lookup_and_add
        lookup_data_source: { section: SORTE }
        on_key: { source_key: Sorte_ID, lookup_key: Sorte_ID }
        select_columns:
          Kultur_ID: Kultur_ID
      - type: lookup_and_add
        lookup_data_source: { section: KULTUR }
        on_key: { source_key: Kultur_ID, lookup_key: Kultur_ID }
        select_columns:
          crop_id:
            type: coalesce_map
            maps:
              - { from: Icc_Code, map: *crop_name_map_icc }
              - { from: Kultur, map: *crop_name_map_de }
      # Document cover crop based on information in AUSSAAT and FRUCHTFOLGE tables
      - type: lookup_and_add
        lookup_data_source: { section: AUSSAAT }
        on_key:
          source_key: [Parzelle_ID, Versuchsjahr, Saat_Pflanzgut_ID]
          lookup_key: [Parzelle_ID, Versuchsjahr, Saat_Pflanzgut_ID]
        select_columns:
          temp_vorfrucht_aussaat: Vorfrucht
      - type: lookup_and_add
        lookup_data_source: { section: FRUCHTFOLGE }
        on_key:
          source_key: [Versuchsjahr, Kultur_ID]
          lookup_key: [Versuchsjahr, Kultur_ID]
        select_columns:
          temp_vorfrucht_fruchtfolge: Vorfrucht
      - type: coalesce_columns
        output_header: temp_vorfrucht
        input_map:
          from_aussaat: temp_vorfrucht_aussaat
          from_fruchtfolge: temp_vorfrucht_fruchtfolge
      - type: add_column_conditional
        output_header: crop_intended_use
        conditions:
          - on_column: temp_vorfrucht
            if_equals: 1
            then_value: 'CO'
      # Look up and join comments
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          harvest_op_comments: Bemerkungen
      # Look up and join machinery data
      - type: lookup_and_add
        lookup_data_source: { section: TECHNIK }
        on_key: { source_key: Technik_ID, lookup_key: Technik_ID }
        select_columns:
          temp_technik: Technik
          temp_art: Art
          temp_beschreibung: Beschreibung
      - type: concatenate_columns
        output_header: harvest_method
        input_map:
          tech: temp_technik
          art: temp_art
          desc: temp_beschreibung
        separator: "; "
        on_missing: proceed
      - type: map_values
        input_map: { x: harvest_method }
        output_header: harvest_method
        map: *harvest_method_map
        default_value: *harvest_method_default
    # ADD CODE MAPPING FOR harvest_methods
    select_final_columns:
      experiment_year: Versuchsjahr
      harvest_operations_level: Ernte_ID
      crop_id: crop_id
      crop_intended_use: crop_intended_use
      harvest_operations_date: Termin
      harvest_method: harvest_method
      harvest_op_comments: harvest_op_comments


## --- SECTIONS: WEATHER ---
    
  - mapping_uid: '15'
    notes: "Assembles the WEATHER_DAILY table from KLIMADATEN."
    source:
      section: KLIMADATEN
    target:
      section: WEATHER_DAILY
    actions:
      # Convert solar radiation from W/m2 to MJ/m2/d.
      - type: rowwise_transform
        output_header: solar_radiation
        input_map:
          x: Globalstrahlung
        formula: "x * 0.0864"
      # Action 2: Convert wind speed from m/s to km/d.
      - type: rowwise_transform
        output_header: wind_speed_daily
        input_map:
          x: Wind
        formula: "x * 86.4"
      # Look up and join comments.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          weather_daily_comments: Bemerkungen
    select_final_columns:
      weather_date: Termin
      solar_radiation: solar_radiation
      maximum_temperature: T_Max_2m
      minimum_temperature: T_Min_2m
      temp_average_daily: T_Mit_2m
      precipitation: Niederschlag_Summe
      daylength_sunrise_sunset: Sonnenstunden
      realtive_humidity_avg: Luftfeuchte # Note: Typo in original ICASA name
      vapor_pressure: Partialdruck
      wind_speed_daily: wind_speed_daily
      weather_daily_comments: weather_daily_comments

  # Note 2025-09-12: the following rule will not work in some edge cases (e.g., different sensor heights in different years)
  - mapping_uid: '16'
    notes: "Assembles the WEATHER_METADATA table from KLIMADATEN."
    source:
      section: KLIMADATEN
    target:
      section: WEATHER_METADATA
    actions:
      # If any 2m temperature column is present.
      - type: add_column
        output_header: temperature_sensor_ht
        value: 2
        condition_on_presence_of:
          - T_Max_2m
          - T_Min_2m
          - T_Mit_2m
      # If the 5cm temperature column is present.
      # TODO: check if should be mapped elsewhere (soil surface temperature?)
      - type: add_column
        output_header: temperature_sensor_ht
        value: 0.05
        condition_on_presence_of:
          - T_Min_5cm           
    select_final_columns:
      temperature_sensor_ht: temperature_sensor_ht


## --- SECTIONS: SOIL ---
    
  - mapping_uid: '17'
    notes: "Assembles the SOIL_PROFILE_LAYERS table from BODENLABORWERTE and linked tables."
    source:
      section: BODENLABORWERTE
    target:
      section: SOIL_PROFILE_LAYERS
    actions:
      # Look up the sampling context (plot, year, depth).
      - type: lookup_and_add
        lookup_data_source: { section: PROBENAHME_BODEN }
        on_key: { source_key: Probenahme_Boden_ID, lookup_key: Probenahme_Boden_ID }
        select_columns:
          experiment_year: Versuchsjahr
          plot_id: Parzelle_ID
          date_of_measurement: Termin
          me_soil_layer_top_depth: Obergrenze
          me_soil_layer_bot_depth: Untergrenze
          temp_sampling_comment_id: Bemerkungen_ID
      # Look up and concatenate lab and sampling comments.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_lab_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: temp_sampling_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_sampling_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: obs_time_series_comment
        input_map:
          sampling_comment: temp_sampling_comment_text
          lab_comment: temp_lab_comment_text
        separator: "; "
        on_missing: proceed
      # Perform a chained join to find the treatment_number.
      - type: lookup_and_add
        lookup_data_source: { section: PARZELLE }
        on_key: { source_key: plot_id, lookup_key: Parzelle_ID }
        select_columns:
          treatment_number: Pruefglied_ID
    select_final_columns:
      experiment_year: experiment_year
      plot_id: plot_id
      treatment_number: treatment_number
      date_of_measurement: date_of_measurement
      me_soil_layer_top_depth: me_soil_layer_top_depth
      me_soil_layer_bot_depth: me_soil_layer_bot_depth
      obs_time_series_comment: obs_time_series_comment     
      # REVIEW: Add all other soil measurement columns from the BODENLABORWERTE source table


## --- SECTION: SUMMARY ---

  - mapping_uid: '18'
    notes: "Assembles SUMMARY table from ERTRAG and linked tables."
    source:
      section: ERTRAG
    target:
      section: SUMMARY
    actions:   
      # Look up and join comments.
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          obs_summary_comment: Bemerkungen
      # Chain lookups to get harvest, plot, and treatment context.
      - type: lookup_and_add
        lookup_data_source: { section: ERNTE }
        on_key: { source_key: Ernte_ID, lookup_key: Ernte_ID }
        select_columns:
          plot_id: Parzelle_ID
          harvest_date: Termin
          experiment_year: Versuchsjahr # Bring in the year
      - type: lookup_and_add
        lookup_data_source: { section: PARZELLE }
        on_key: { source_key: plot_id, lookup_key: Parzelle_ID }
        select_columns:
          treatment_number: Pruefglied_ID
      # Convert yield measurement units
      ## Convert main product dry matter yield from dt/ha to kg/ha
      - type: rowwise_transform
        output_header: harvest_yld_matur_dry_wt
        input_map:
          x: { header: Hp_Trockenmasse, synonyms: [hp_trockenmasse] }
        formula: "x * 100"
      ## Convert by-product dry matter yield from dt/ha to kg/ha
      - type: rowwise_transform
        output_header: byprod_removed_at_harv
        input_map:
          x: { header: Np_Trockenmasse, synonyms: [np_trockenmasse] }
        formula: "x * 100"
      ## Convert main product fresh matter yield from t/ha to kg/ha
      - type: rowwise_transform
        output_header: harv_yield_matur_f_wt
        input_map:
          x: { header: Hp_Frischmasse, synonyms: [hp_frischmasse] }
        formula: "x * 1000"
    select_final_columns:
      experiment_year: experiment_year
      treatment_number: treatment_number
      plot_id: plot_id
      harvest_date: harvest_date
      harv_yield_matur_f_wt: harv_yield_matur_f_wt
      harvest_yld_matur_dry_wt: harvest_yld_matur_dry_wt
      dry_matter_content: Hp_Trockensubstanzgehalt
      byprod_removed_at_harv: byprod_removed_at_harv
      obs_summary_comment: obs_summary_comment


## --- SECTION: TIME_SERIES ---
        
  - mapping_uid: '19'
    notes: "Assembles TIME_SERIES table from PFLANZENLABORWERTE and linked tables."
    source:
      section: PFLANZENLABORWERTE 
    target:
      section: TIME_SERIES
    actions:
      # Look up context and comments
      - type: lookup_and_add
        lookup_data_source: { section: PROBENAHME_PFLANZEN }
        on_key: { source_key: Probenahme_Pflanzen_ID, lookup_key: Probenahme_Pflanzen_ID }
        select_columns:
          experiment_year: Versuchsjahr
          plot_id: Parzelle_ID
          date_of_measurement: Termin
          temp_sampling_comment_id: Bemerkungen_ID
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: Bemerkungen_ID, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_lab_comment_text: Bemerkungen
      - type: lookup_and_add
        lookup_data_source: { section: BEMERKUNGEN }
        on_key: { source_key: temp_sampling_comment_id, lookup_key: Bemerkungen_ID }
        select_columns:
          temp_sampling_comment_text: Bemerkungen
      - type: concatenate_columns
        output_header: obs_time_series_comment
        input_map:
          lab_comment: temp_lab_comment_text
          sampling_comment: temp_sampling_comment_text
        separator: "; "
        on_missing: proceed
      # Look up and join treatment IDs
      - type: lookup_and_add
        lookup_data_source: { section: PARZELLE }
        on_key: { source_key: plot_id, lookup_key: Parzelle_ID }
        select_columns:
          treatment_number: Pruefglied_ID
      # Convert measured variables
      ## Convert main product dry matter yield from dt/ha to kg/ha
      - type: rowwise_transform
        output_header: harvest_yield_at_day_dw
        input_map:
          x: Hp_Trockenmasse
        formula: "x * 100"
      ## Calculate yield moisture content (%) from fresh yield dry matter content (%)
      - type: rowwise_transform
        output_header: yield_moisture_content
        input_map:
          dm_conc: { header: Hp_Trockensubstanzgehalt, synonyms: [TS] }
        formula: "100 - dm_conc"
      ## Calculate grain unit weight (mg) from thousand-grain-weight (g)
      - type: rowwise_transform
        output_header: grain_unit_dry_weight
        input_map:
          TGW: TKG
        formula: "(TGW / 1000) * 1000"   # Note: explicit for transparency (transformation + conversion)
      ## Calculate grain N content (kg/ha) from N concentration (%) and dry matter yield (dt/ha)
      - type: rowwise_transform
        output_header: grain_N
        input_map:
          yield: Hp_Trockenmasse
          n_conc: { header: Stickstoff, synonyms: ['N', Nitrogen] }
        formula: "(yield * 100) * (n_conc / 100)"
      ## Calculate grain P content (kg/ha) from P concentration (%) and dry matter yield (dt/ha)
      - type: rowwise_transform
        output_header: grain_P
        input_map:
          yield: Hp_Trockenmasse
          p_conc: { header: Phosphor, synonyms: ['P', Phosphorus] }
        formula: "(yield * 100) * (p_conc / 100)"
      ## Calculate grain K content (kg/ha) from K concentration (%) and dry matter yield (dt/ha)
      - type: rowwise_transform
        output_header: grain_K
        input_map:
          yield: Hp_Trockenmasse
          k_conc: { header: Kalium, synonyms: ['K', Potassium] }
        formula: "(yield * 100) * (k_conc / 100)"
        # This map defines the complete and clean output for the TIME_SERIES table.
    select_final_columns:
      experiment_year: experiment_year
      plot_id: plot_id
      treatment_number: treatment_number
      date_of_measurement: date_of_measurement
      harvest_yield_at_day_dw: harvest_yield_at_day_dw
      yield_moisture_content: yield_moisture_content
      grain_unit_dry_weight: grain_unit_dry_weight
      grain_N: grain_N
      grain_N_conc: Stickstoff
      grain_P: grain_P
      grain_P_conc: Phosphor
      grain_K: grain_K
      grain_K_conc: Kalium
      grain_protein_concentration: Protein
      grain_oil_conc: Oel
      obs_time_series_comment: obs_time_series_comment


# -----------------------------------------------------------------
# PHASE 2: Schema Application
# -----------------------------------------------------------------

# TODO: Apply all date formats
  - mapping_uid: '999'
    actions:
      - type: apply_formats
        target_section: GENERAL
        formats:
          revision_date_first: "%Y-%m-%d"
          revision_date_latest: "%Y-%m-%d"
      - type: apply_formats
        target_section: PLANTINGS
        formats:
          planting_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: IRRIGATIONS
        formats:
          irrigation_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: FERTILIZERS
        formats:
          fertilization_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: ORGANIC_MATERIALS
        formats:
          org_material_applic_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: CHEMICALS
        formats:
          chemical_applic_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: TILLAGE
        formats:
          tillage_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: HARVESTS
        formats:
          harvest_operations_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: WEATHER_DAILY
        formats:
          weather_date: "%Y-%m-%d"
      # - type: apply_formats
      #   target_section: SOIL_PROFILE_LAYERS
      #   formats:
      #     date_of_measurement: "%Y-%m-%d"
      - type: apply_formats
        target_section: SUMMARY
        formats:
          harvest_date: "%Y-%m-%d"
      - type: apply_formats
        target_section: TIME_SERIES
        formats:
          date_of_measurement: "%Y-%m-%d"


