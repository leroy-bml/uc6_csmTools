# BonaRes-LTE to ICASA data map (v0.0.9; verbose)

# ---- Phase 1: Data Transformation Rules ---

- mapping_uid: '1'
  notes: "Pass through all columns that only need renaming."
  source:
    section: DATA  # to set/test
  target:
    section: STATION_METADATA
  actions:
    - type: pass_through
      headers:
        - latitude
        - longitude

- mapping_uid: '2'
  notes: "Pass through all columns that only need renaming."
  source:
    section: DATA
    keys:
      - time
    header: pr
  target:
    section: WEATHER_DAILY
  actions:
    - type: pass_through

- mapping_uid: '3'
  source:
    section: DATA
    keys: 
      - time
    header: tas
  target:
    section: WEATHER_DAILY
  actions:
    - type: pass_through
    - type: add_column
      output_header: temperature_sensor_ht
      value: 2
      target_section: STATION_METADATA

- mapping_uid: '4'
  source:
    section: DATA
    keys: 
      - time
    header: tasmin
  target:
    section: WEATHER_DAILY
  actions:
    - type: pass_through
    - type: add_column
      output_header: temperature_sensor_ht
      value: 2
      target_section: STATION_METADATA

- mapping_uid: '5'
  source:
    section: DATA
    keys: 
      - time
    header: tasmax
  target:
    section: WEATHER_DAILY
  actions:
    - type: pass_through
    - type: add_column
      output_header: temperature_sensor_ht
      value: 2
      target_section: STATION_METADATA

- mapping_uid: '6'
  notes: 'Convert wind speed from m/s to km/d'
  source:
    section: DATA
    keys: 
      - time
    header: sfcWind
  target:
    section: WEATHER_DAILY
  actions:
    - type: rowwise_transform
      output_header: sfcWind
      input_map:
        x: sfcWind
      formula: "x * 86.4"

- mapping_uid: '7'
  notes: 'Convert wind speed from m/s to km/d'
  source:
    section: DATA
    keys: 
      - time
    header: rsds
  target:
    section: WEATHER_DAILY
  actions:
    - type: rowwise_transform
      output_header: rsds
      input_map:
        x: rsds
      formula: "x * xxxxxx"

- mapping_uid: '999'
  notes: "Schema application for all output tables."
  actions:
    - type: map_headers
      target_section: GENERAL
      rename_list:
        - {from: Experiment_name, to: name_of_experiment}
        - from: 
            header: METADATA.Abstract
            synonyms: [METADATA.Summary]
        - to: experiment_narrative
        - {from: METADATA.Date_published, to: revision_date_first}
        - {from: METADATA.Date_revised, to: revision_date_latest}
        - {from: METADATA.Funding, to: ex_funding_source}
        # Note: Mapping one source to multiple outputs (distrib_restrictions, ex_license)
        # must be handled in Phase 1 with a branching rule.
        - {from: METADATA.Legal_constrainsts, to: distrib_restrictions}

    - type: map_headers
      target_section: WEATHER_DAILY
      rename_list:
        - {from: KLIMADATEN.Termin, to: weather_date}
        - {from: KLIMADATEN.Globalstrahlung, to: solar_radiation}
        - {from: KLIMADATEN.T_Max_2m, to: maximum_temperature}
        - {from: KLIMADATEN.T_Min_2m, to: minimum_temperature}
        - {from: KLIMADATEN.T_Min_5cm, to: minimum_temperature}
        - {from: KLIMADATEN.T_Mit_2m, to: temp_average_daily}
        - {from: KLIMADATEN.Niederschlag_Summe, to: precipitation}
        - {from: KLIMADATEN.Wind, to: wind_speed_daily}
        - {from: KLIMADATEN.Sonnenstunden, to: daylength_sunrise_sunset}
        - {from: KLIMADATEN.Luftfeuchte, to: realtive_humidity_avg}
        - {from: KLIMADATEN.Partialdruck, to: vapor_pressure}
        - {from: KLIMADATEN.Himmel, to: weather_daily_comments}
        - {from: BEMERKUNGEN.Bemerkungen, to: weather_daily_comments}
      format_map:
        weather_date: '%Y-%m-%d'  # Note: example formatting
    
    - type: map_headers
      target_section: WEATHER_METADATA
      rename_list:
        - {from: temperature_sensor_ht, to: temperature_sensor_ht}

    - type: map_headers
      target_section: SOIL_LAYERS
      rename_list:
        - {from: Versuchsjahr, to: experiment_year}
        - {from: Pruefglied_ID, to: treatment_number}
        - {from: Parzelle_ID, to: plot_id}
        - {from: PROBENAHME_BODEN.Termin, to: date_of_measurement}
        - {from: PROBENAHME_BODEN.Obergrenze, to: me_soil_layer_top_depth}
        - {from: PROBENAHME_BODEN.Untergrenze, to: me_soil_layer_bot_depth}
        - {from: BEMERKUNGEN.Bemerkungen, to: obs_time_series_comment}

    - type: map_headers
      target_section: SUMMARY
      rename_list:
        - {from: Versuchsjahr, to: experiment_year}
        - {from: Pruefglied_ID, to: treatment_number}
        - {from: Parzelle_ID, to: plot_id}
        - {from: ERNTE.Termin, to: harvest_date}
        - {from: ERTRAG.Hp_Trockenmasse, to: harvest_yld_matur_dry_wt}
        - {from: ERTRAG.Hp_Frischmasse, to: harv_yield_matur_f_wt}
        #- {from: ERTRAG.Hp_Trockensubstanzgehalt, to: dry_matter_content}
        - {from: ERTRAG.Np_Trockenmasse, to: byprod_removed_at_harv}
        - {from: BEMERKUNGEN.Bemerkungen, to: obs_summary_comment}  # Note: 2025-08-05 not in ICASA

    - type: map_headers
      target_section: TIME_SERIES
      rename_list:
        - {from: Versuchsjahr, to: experiment_year}
        - {from: Pruefglied_ID, to: treatment_number}
        - {from: Parzelle_ID, to: plot_id}
        - {from: PROBENAHME_PFLANZEN.Termin, to: date_of_measurement}
        - {from: PFLANZENLABORWERTE.Hp_Trockenmasse, to: harvest_yield_at_day_dw}
        - {from: yield_moisture_content, to: yield_moisture_content}
        #- {from: ERTRAG.Hp_Trockenmasse, to: harvest_yield_at_day_dw}  # Note: conditional routing on harvest date
        #- {from: ERTRAG.Hp_Frischmasse, to: harvest_yield_fresh_wt}
        #- {from: ERTRAG.Hp_Trockensubstanzgehalt, to: yield_dry_matter_content}
        #- {from: ERTRAG.Np_Trockenmasse, to: dead_canopy_dry_wt}
        - {from: PFLANZENLABORWERTE.Stickstoff, to: grain_N_conc}
        - {from: grain_N_content, to: grain_N}
        - {from: PFLANZENLABORWERTE.Phosphor, to: grain_P_conc}
        - {from: grain_P_content, to: grain_P}
        - {from: grain_K_content, to: grain_K}
        - {from: grain_unit_weight, to: grain_unit_dry_weight}
        - {from: PFLANZENLABORWERTE.Protein, to: grain_protein_concentration}
        - {from: PFLANZENLABORWERTE.Oel, to: grain_oil_conc}
        - {from: BEMERKUNGEN.Bemerkungen, to: obs_time_series_comment}

